## 第26章 并发：介绍

###### Q：何为线程，它和进程的区别在哪里？
A：关于程序运行的经典观点是，一个程序只有一个执行点（一个程序计数器PC，用来存放要执行的指令）。但是在支持多线程的程序中，存在多个执行点，这是为了提高CPU的利用率，加快程序执行速度，提高性能。按照定义，线程是CPU独立调度和分派的最小单位，寄生在进程中，实现了进程内的并发。进程是系统进行资源分配和调度的基本单元，实现了操作系统内的并发。所以，进程和线程作为对CPU不同粒度的抽象，都可以实现并发，提高CPU资源使用率。

同一个进程内多个线程共享全部系统资源，包括地址空间、文件描述符和信号处理等。线程只拥有自己的调用栈、寄存器和线程本地存储。当CPU在进程之间切换时，操作系统和硬件要共同负责将当先进程的上下文信息保存在进程控制块PCB中，而在线程之间切换时，需要将当前线程的上下文信息保存在线程控制块TCB中。

|      | Process 进程                                     | Thread 线程                              |
| ---- | ------------------------------------------------ | ---------------------------------------- |
| 定义 | 系统进行资源分配和调度的基本单位                 | CPU可独立调度和分派的最小单位            |
| 资源 | 地址空间、文件描述符、信号处理、寄存器等一切资源 | 栈、寄存器，线程本地                     |
| 开销 | 切换时开销大，需要将上下文保存在PCB中            | 开销小，保存线程控制块TCB中              |
| 通信 | IPC：信号、管道、信号量、共享内存、消息队列      | 共享内存                                 |
| 健壮 | 进程之间相互隔离，互不影响，健壮                 | 一个线程异常，会导致整个进程终止，不健壮 |

###### Q：线程在进场内实现了并发，但也让代码的实际执行逻辑变得难以理解，为什么会这样？
A：虽然创建线程的顺序是确定的，线程的实际执行顺序完全取决于**调度程序**的决定，这是不可预测的，有可能先创建的先执行，也有可能后创建的先执行，一切皆有可能。

###### Q：除了线程的调度顺序不可控之外，多线程中还有一个重要问题，是什么？
A：如果多个线程同时访问同一个资源，可能造成数据不一致。比如两个线程A和B同时对同一个文件进行读写操作，很有可能线程A正在读的时候，B正在修改，也可能A和B正在同时修改，这就会造成最终的结果不是正确的结果。通常，被同时操作的资源称为临界资源，对应代码称为临界区，这些部分需要按照某种规则有序执行，或者借助硬件帮助，将整个操作原子化，即要么全执行完，要么别执行，0或1，没有中间状态。



